# Docker Compose configuration file for local development
# This file defines multi-container environment for testing the application locally

version: "3.8"
# Define the container
services:
  # Web Service with Nginx
  web:
    # Builds the image from the current directory's Dockerfile
    build:
      context: .
      dockerfile: Dockerfile
    # Container name for easy reference and access
    container_name: jdevops-website
    # Maps local machine port 8080 to port 80 in the container
    ports:
      - "8080:80"
    # Mount a volume for live development to edit files locally and see changes immediately
    volumes:
      - ./static:/usr/share/nginx/html:ro # read-only
      - ./nginx.conf:/etc/nginx/nginx.conf:ro # read-only
    # Environment variables passed to the container
    environment:
      # NGINX_LOGLEVEL controls the verbosity of Nginx logs
      NGINX_LOGLEVEL: "info"
    # Container restart policy
    restart: unless-stopped
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        # Limit log file size to 10MB
        max-size: "10m"
        # Keep only 3 old log files
        max-file: "3"
    # Health check - Verify the container is working. Runs every 30 seconds and considered unhealthy after 3 failures
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # Testing - Node.js container for validation tests
  test-web:
    # Node.js Alpine image for lightweight container
    image: node:20-alpine
    container_name: jdevops-tests-web
    # Working directory inside the container
    working_dir: /app
    # Mount volumes for test files and code
    volumes:
      # Mount the entire project directory to access all files
      - .:/app
      - node_modules:/app/node_modules
    # Port mapping for the test server (if needed)
    ports:
      - "5000:5000"
    # Command to run when container starts, install dependencies and keep the container running
    command: sh -c "npm ci && npm run test 2>/dev/null || sleep infinity"
    # Wait for the web service to be healthy before starting
    depends_on:
      web:
        condition: service_healthy
    # Environment variables for testing
    environment:
      # Use the docker service name as the URL for tests
      CYPRESS_baseUrl: "http://web:80"
    # Restart policy
    restart: "no"
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  # Python Testing Service - For Selenium and Pytest tests
  test-python:
    # Python Alpine image
    image: python:3.11-alpine
    container_name: jdevops-tests-python
    # Working directory
    working_dir: /app
    # Mount volumes for test files
    volumes:
      - .:/app
      # Mount Python dependencies
      - python_packages:/usr/local/lib/python3.11/site-packages
    # Command to install dependencies and keep container running
    command: sh -c "pip install --no-cache-dir -r requirements.txt && sleep infinity"
    # Dependencies
    depends_on:
      web:
        condition: service_healthy
    # Environment variables for tests
    environment:
      # Point tests to the Docker service
      US_SITE: "http://web:80"
      HEADLESS: "true"
    # Restart policy
    restart: "no"
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

# Networks - Define custom networks for service communication
networks:
  # Default network created automatically by Docker Compose
  default:
    driver: bridge
    name: jdevops-network

# Volumes - Persistent storage for data across container
volumes:
  # Persist Node modules to avoid reinstalling
  node_modules:
    driver: local
  # Persist Python packages
  python_packages:
    driver: local
